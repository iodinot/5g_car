## 电机 PID 控制代码技术文档

### 1. 概述
本文档记录了对差速小车电机 PID 控制代码的学习与探索过程，包括 PID 控制算法的基本原理、差速小车电机的控制逻辑以及代码的详细分析。通过 PID 控制实现对小车左右轮的速度与位置的精准调节，以保证小车能够按照预定的路径或角度进行移动和旋转。

### 2. 代码结构与模块说明

#### 2.1 文件结构
- **`moto_control.h`**：头文件，定义了电机控制所需的宏和结构体。
- **`moto_control.c`**：实现文件，包含 PID 控制逻辑、电机控制函数以及运动控制的主逻辑。

#### 2.2 宏定义
- **`LENGTH_WHEEL`**：轮子的周长，单位为米（m），用于计算轮子的旋转角度与小车行驶距离之间的转换关系。
- **`LENGTH_FROM_WHEEL_TO_CENTER`**：轮子到两轮中间的距离，用于计算小车转向时轮子的弧长。
- **`Hall_11`**：编码器的精度，用于计算轮子转动的距离。

#### 2.3 结构体定义
- **`pidStructdef_l` 和 `pidStructdef_r`**：用于分别定义左右轮 PID 控制参数的结构体。主要包含以下字段：
  - `kp`、`ki`、`kd`：PID 控制中的比例系数、积分系数和微分系数。
  - `error`：当前误差值。
  - `L_error`：上一次误差值。
  - `L_L_error`：上上次误差值，用于计算误差的微分。
  - `integral`：误差积分值，用于消除系统稳态误差。
  - `out`：PID 控制的输出值。

#### 2.4 PID 参数配置
代码中分别为左右轮设置了位置环和速度环的 PID 参数：

- **位置环控制参数**
  - 左轮：`{4.3, 2.1, 1.5, 0, 0, 0, 0}`
  - 右轮：`{4.3, 2.2, 1.7, 0, 0, 0, 0}`
- **速度环控制参数**
  - 左轮：`{3, 1, 0, 0, 0, 0, 0}`
  - 右轮：`{10, 5, 0, 0, 0, 0, 0}`

### 3. 电机控制函数说明

#### 3.1 电机运行方向控制函数
- **`Moto_forward_run()`**：使两个电机正向转动，控制小车前进。
- **`Moto_back_run()`**：使两个电机反向转动，控制小车后退。
- **`Moto_stop()`**：停止两个电机转动，使小车停止运动。
- **`Moto_turn_left()`**：控制左轮反转、右轮正转，使小车左转。
- **`Moto_turn_right()`**：控制右轮反转、左轮正转，使小车右转。

#### 3.2 PID 控制计算函数
- **`pid_cal_l()`** 和 **`pid_cal_r()`**：分别为左轮和右轮的 PID 计算函数。
  - `mode == SPEED`：当模式为速度环控制时，采用增量式 PID 算法。
  - `mode == POSITION`：当模式为位置环控制时，采用位置式 PID 算法。

两者的输出范围被限制在 `0 ~ 1000` 之间，用于控制 PWM 占空比的输出。

#### 3.3 PWM 输出函数
- **`Set_TIM_PWM(EWHEEL wheel, uint16_t ccr_val)`**：
  - 根据 `ccr_val` 设置对应电机的 PWM 占空比，用于调节电机的转速。
  - `ccr_val` 的范围被限制在 `0 ~ 1000` 之间，以避免溢出。

### 4. PID 控制原理

PID（比例 - 积分 - 微分）控制是一种常用的闭环控制算法，通过实时计算系统的当前误差，动态调节控制变量，从而达到设定值。
PID 控制算法的输出可以表示为：

\[
\text{output} = K_p \cdot e(t) + K_i \cdot \int_0^t e(\tau) \, d\tau + K_d \cdot \frac{de(t)}{dt}
\]

其中：
- \(K_p\) 是比例系数
- \(K_i\) 是积分系数
- \(K_d\) 是微分系数
- \(e(t)\) 是当前误差
- \(\int_0^t e(\tau) \, d\tau\) 是误差的积分
- \(\frac{de(t)}{dt}\) 是误差的微分


在代码中，分别使用了增量式 PID 和位置式 PID：

- **增量式 PID**：通过当前误差与前一次误差的差值调节输出量，适合速度环控制，计算简单、易于实现。
- **位置式 PID**：通过误差的绝对值及其积分、微分调节输出量，适合位置环控制，能够精确控制位置的变化。

### 5. 差速小车控制逻辑

差速小车的运动控制包括前进、后退、左右转向等行为，通过 PID 控制调节两个轮子的转速差来实现不同的运动模式。

- **前进/后退**：左右轮同时以相同的速度正向/反向转动。
- **左转/右转**：通过左右轮以不同的速度或反向转动来控制小车的转弯角度。
- **定点旋转**：左轮与右轮以相反的方向转动，小车以中心为轴进行旋转。

graph TD
    A[开始] --> B{获取目标速度或位置}
    B -->|目标速度| C[速度控制模式]
    B -->|目标位置| D[位置控制模式]
    
    C --> E[计算当前速度]
    E --> F[计算PID控制输出]
    F --> G[设置PWM输出]
    
    D --> H[计算当前位置信息]
    H --> I[计算PID控制输出]
    I --> J[设置PWM输出]

    G --> K[更新电机状态]
    J --> K
    K --> L[反馈速度与位置]
    L -->|反馈满足| M{是否到达目标}
    L -->|未满足| N[继续PID控制]
    
    M -->|是| O[停止电机]
    M -->|否| N
    
    O --> P[结束]

    style A fill:#f9f,stroke:#333,stroke-width:4px
    style P fill:#ff0,stroke:#333,stroke-width:4px

### 6. 关键函数详解

#### 6.1 `speed_control_l` 和 `speed_control_r`
这两个函数分别用于左右轮的速度环 PID 控制：
- 通过调用 `pid_cal_l()` 或 `pid_cal_r()` 计算 PID 输出值。
- 调用 `Set_TIM_PWM()` 设置 PWM 占空比来调节电机转速。

#### 6.2 `moto_control_l` 和 `moto_control_r`
分别为左右轮的运动控制入口函数：
- 根据 `control_mode` 选择是速度环还是位置环控制。
- 速度环：调用 `speed_control_l()` 或 `speed_control_r()`。
- 位置环（若定义 `USE_POSITION`）：调用 `position_control()` 实现位置控制。

#### 6.3 `set_turn_angle`
该函数用于控制小车旋转固定角度：
- 根据小车的转动方向和设置的角度，计算轮子需要转动的弧长。
- 通过 PID 控制调节左右轮的速度，使得小车达到目标角度后停止。

### 7. 学习与调试过程总结

在开发和调试电机 PID 控制程序的过程中，遇到了以下几个难点和解决方案：

1. **PID 参数调试**：初次设置 PID 参数时容易出现过冲或系统震荡。通过不断调整 `kp`、`ki` 和 `kd`，观察系统响应，最终找到较为合适的参数。
2. **编码器读取精度与系统时延**：编码器的精度对 PID 控制有较大影响，通过优化编码器的读取频率与误差处理，使系统能够更平滑地响应目标速度或位置。
3. **电机的启动与停止抖动**：电机在启动和停止时可能会出现抖动，通过增加误差死区和降低启动时的 PID 输出值，减小了抖动的幅度。

### 8. 结论

本次学习与探索过程，通过深入理解 PID 控制算法，并将其应用于差速小车电机控制中，实现了对左右轮的精准控制。通过对代码的逐行分析与调试，能够掌握 PID 控制在实际工程应用中的设计与调试技巧，为后续的复杂运动控制算法开发奠定了基础。